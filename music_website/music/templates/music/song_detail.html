<!-- templates/music/song_detail.html -->
{% extends 'music/base.html' %}

{% block title %}{{ song.title }} - æ­Œæ›²è¯¦æƒ…{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <div style="flex-shrink: 0;">
            {% load static %}
            <img src="{% static song.get_image_path%}" alt="{{ song.title }}" 
                 style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"
                 onerror="handleImageError(this)">
        </div>
        <div style="flex: 1; min-width: 300px;">
            <h1 style="color: var(--primary-color); margin-bottom: 1rem;">{{ song.title }}</h1>
            <p style="margin-bottom: 0.5rem;"><strong>æ­Œæ‰‹:</strong> 
                {% if song.get_artist_obj %}
                    <a href="{% url 'artist_detail' song.get_artist_obj.id %}" style="color: var(--primary-color); text-decoration: none;">
                        {{ song.artist }}
                    </a>
                {% else %}
                    {{ song.artist }}
                {% endif %}
            </p>
            <p style="margin-bottom: 0.5rem;"><strong>ä¸“è¾‘:</strong> {{ song.album|default:"æœªçŸ¥ä¸“è¾‘" }}</p>
            {% if song.description %}
                <p style="margin-bottom: 1rem;"><strong>æè¿°:</strong> {{ song.description }}</p>
            {% endif %}
            {% if song.url %}
                <p style="margin-bottom: 1rem;">
                    <a href="{{ song.url }}" target="_blank" class="btn btn-primary">ğŸ”— è®¿é—®åŸå§‹ç½‘ç«™</a>
                </p>
            {% endif %}
        </div>
    </div>

    {% if song.lyric %}
    <div class="card-header">
        <h3>æ­Œè¯</h3>
    </div>
    <div style="background-color: var(--hover-color); padding: 2.5rem; padding-left: 4.5rem; font-size: 16px; border-radius: 8px; margin-bottom: 2rem; white-space: pre-wrap; font-family: monospace;">{{ song.lyric }}</div>
    {% endif %}

    <!-- è¯„è®ºåŒº -->
    <div class="card-header">
        <h3>è¯„è®º ({{ comments.count }})</h3>
    </div>

    <!-- è¯„è®ºè¡¨å• -->
    <form method="post" action="{% url 'add_comment' song.id %}" style="margin-bottom: 2rem;">
        {% csrf_token %}
        <div style="margin-bottom: 1rem;">
            <textarea name="content" rows="4" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." 
                    style="width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: 4px; background-color: var(--background-color); color: var(--text-color); resize: vertical;" 
                    required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
    </form>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div>
        {% for comment in comments %}
        <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background-color: var(--hover-color);" data-comment-id="{{ comment.id }}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                <div style="flex: 1;">
                    <div style="white-space: pre-wrap; line-height: 1.6;">{{ comment.content }}</div>
                </div>
                <form method="post" action="{% url 'delete_comment' comment.id %}" style="margin-left: 1rem;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—?')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">åˆ é™¤</button>
                </form>
            </div>
            <div style="font-size: 0.9rem; color: #666;">
                {{ comment.created_at|date:"Y-m-d H:i:s" }}
            </div>
        </div>
        {% empty %}
        <p style="text-align: center; color: #666; font-style: italic;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
        {% endfor %}
    </div>
</div>

<div style="margin-top: 1rem;">
    <a href="{% url 'song_list' %}" class="btn btn-primary">â† è¿”å›æ­Œæ›²åˆ—è¡¨</a>
</div>
{% endblock %}

{% comment %} {% block script %}
<script>
    // è·å– CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // æ·»åŠ è¯„è®º
    document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('commentContent').value.trim();
        
        if (!content) {
            alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
            return;
        }
        
        const formData = new FormData();
        formData.append('content', content);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch(`{% url 'add_comment' song.id %}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // æˆåŠŸååˆ·æ–°é¡µé¢
                location.reload();
            } else {
                alert('æ·»åŠ è¯„è®ºå¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('æ·»åŠ è¯„è®ºå¤±è´¥');
        });
    });
    
    // åˆ é™¤è¯„è®º
    function deleteComment(event, commentId) {
        event.preventDefault();
        
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—?')) {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            
            fetch(`{% url 'delete_comment' 0 %}`.replace('0', commentId), {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // æˆåŠŸååˆ·æ–°é¡µé¢
                    location.reload();
                } else {
                    alert('åˆ é™¤è¯„è®ºå¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('åˆ é™¤è¯„è®ºå¤±è´¥');
            });
        }
        
        return false;
    }
</script>
{% endblock %} {% endcomment %}